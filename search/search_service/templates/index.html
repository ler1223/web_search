<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Product Search</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --gray: #8d99ae;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .search-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 0 0 20px 20px;
            padding: 2rem 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.3);
        }

        .search-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .search-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .search-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .search-container {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #dbdbdb;
            border-radius: 12px;
            padding: 40px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-container:hover {
            border-color: var(--primary);
            background: #f0f4ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
        }

        .upload-hint {
            color: var(--gray);
            font-size: 0.9rem;
        }

        #uploadInput {
            display: none;
        }

        .preview-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-button {
            margin-top: 20px;
            width: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            font-weight: 600;
            padding: 1rem;
            border-radius: 10px;
            transition: all 0.3s;
            color: white;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(67, 97, 238, 0.4);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .product-image-container {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .product-info {
            padding: 1.2rem;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            line-height: 1.4;
        }

        .product-categories {
            margin-bottom: 10px;
        }

        .category-tag {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
            margin-right: 5px;
        }

        .product-price {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .discount-price {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .actual-price {
            font-size: 0.9rem;
            color: var(--gray);
            text-decoration: line-through;
            margin-left: 8px;
        }

        .viewed-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .discount-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ff3860;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 2rem 0 1.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
        }

        .results-title i {
            margin-right: 10px;
            color: var(--primary);
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .no-results i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-button:hover {
            color: #333;
        }

        .modal-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .buy-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .buy-button {
            flex: 1;
            padding: 12px;
            font-weight: bold;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loader-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }

            .search-header {
                padding: 1.5rem 1rem;
            }

            .search-container {
                padding: 1.5rem;
            }
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .full-product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-only-card {
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <!-- Вкладки поиска -->
            <div class="search-tabs">
                <div class="search-tab active" data-tab="text-search">
                    <i class="fas fa-search"></i> &nbsp; Text Search
                </div>
                <div class="search-tab" data-tab="image-search">
                    <i class="fas fa-image"></i> &nbsp; Image Search
                </div>
            </div>

            <!-- Поиск по тексту -->
            <div class="tab-content active" id="text-search">
                <div class="search-container">
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input is-medium"
                                   type="text"
                                   placeholder="Find a product..."
                                   id="textSearchInput">
                        </div>
                        <div class="control">
                            <button class="button is-info is-medium search-button" id="textSearchBtn">
                                <i class="fas fa-search"></i> &nbsp; Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Поиск по изображению -->
            <div class="tab-content" id="image-search">
                <div class="search-container">
                    <div class="upload-container" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <div class="upload-text">Upload an image</div>
                        <div class="upload-hint">Drag & drop or click to browse</div>
                        <input type="file" id="uploadInput" accept="image/*">
                    </div>

                    <div class="preview-container" id="previewContainer">
                        <img id="previewImage" class="preview-image" src="" alt="Preview">
                        <div class="mt-3">
                            <button type="button" class="button is-light" id="changeImageBtn">
                                Change Image
                            </button>
                        </div>
                    </div>

                    <button class="button search-button has-text-white" id="imageSearchBtn">
                        <i class="fas fa-search"></i> &nbsp; Search Similar Products
                    </button>
                </div>
            </div>

            <!-- Сообщения -->
            <div class="error-message" id="errorMessage"></div>
            <div class="loader" id="loader">
                <div class="loader-spinner"></div>
                <p class="mt-3">Searching for products...</p>
            </div>

            <!-- Контейнер для результатов -->
            <div id="searchResults">
            </div>
        </div>
    </section>

    <script>
        // Элементы DOM
        const textSearchInput = document.getElementById('textSearchInput');
        const textSearchBtn = document.getElementById('textSearchBtn');
        const imageSearchBtn = document.getElementById('imageSearchBtn');
        const uploadInput = document.getElementById('uploadInput');
        const searchResults = document.getElementById('searchResults');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');

        // Получение CSRF токена для Django
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }

        // Показать/скрыть лоадер
        function showLoader() {
            loader.style.display = 'block';
        }

        function hideLoader() {
            loader.style.display = 'none';
        }

        // Кнопка смены изображения
        changeImageBtn.addEventListener('click', () => {
            previewContainer.style.display = 'none';
            uploadArea.style.display = 'flex';
            uploadInput.value = '';
        });

        document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const uploadInput = document.getElementById('uploadInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const changeImageBtn = document.getElementById('changeImageBtn');

        // Клик по области загрузки
        uploadArea.addEventListener('click', () => {
            uploadInput.click();
        });

        // Выбор файла
        uploadInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                    uploadArea.style.display = 'none';
                }

                reader.readAsDataURL(this.files[0]);
            }
        });

        // Кнопка смены изображения
        changeImageBtn.addEventListener('click', () => {
            previewContainer.style.display = 'none';
            uploadArea.style.display = 'flex';
            uploadInput.value = '';
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                uploadInput.files = e.dataTransfer.files;
                uploadInput.dispatchEvent(new Event('change'));
            }
        });
    });

        // Показать ошибку
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Код переключения вкладок ДОЛЖЕН быть здесь
            const searchTabs = document.querySelectorAll('.search-tab');

            searchTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');

                    // Убираем active у всех
                    searchTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    // Добавляем active к выбранной
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        });


        // Текстовый поиск
        async function performTextSearch(query) {
            try {
                showLoader();
                hideError();

                const response = await fetch(`/api/search/?q=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayResults(data.products || []);

            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed: ' + error.message);
            } finally {
                hideLoader();
            }
        }

        // Поиск по изображению
        async function performImageSearch(imageFile) {
            try {
                showLoader();
                hideError();

                const formData = new FormData();
                formData.append('image', imageFile);

                // Добавляем CSRF токен если используется Django
                const csrfToken = getCSRFToken();
                if (csrfToken) {
                    formData.append('csrfmiddlewaretoken', csrfToken);
                }

                const response = await fetch('/api/search_by_image/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayResults(data.products || []);

            } catch (error) {
                console.error('Image search error:', error);
                showError('Image search failed: ' + error.message);
            } finally {
                hideLoader();
            }
        }

        // Отображение результатов
        function displayResults(products) {
            if (!products || products.length === 0) {
                searchResults.innerHTML = `<div class="no-results">No products found</div>`;
                return;
            }

            const productsHTML = products.map(product => {
                // Проверяем тип данных
                const hasFullData = product.name && product.main_category; // Есть полные данные
                const hasOnlyImage = product.image && !product.name; // Только изображение

                if (hasFullData) {
                    // Полная карточка
                    return `
                        <div class="full-product-card">
                            <img src="${product.image}" class="product-image">
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                <div class="categories">
                                    <span class="category">${product.main_category}</span>
                                    ${product.sub_category ? `<span class="category">${product.sub_category}</span>` : ''}
                                </div>
                                <div class="prices">
                                    ${product.discount_price ? `<span class="discount-price">${product.discount_price}</span>` : ''}
                                    ${product.actual_price ? `<span class="actual-price">${product.actual_price}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (hasOnlyImage) {
                    // Только изображение
                    return `
                        <div class="image-only-card">
                            <img src="${product.image}" class="product-image">
                        </div>
                    `;
                }

                return ''; // Пропускаем если данные не подходят
            }).join('');

            searchResults.innerHTML = `
                <div class="products-grid">
                    ${productsHTML}
                </div>
            `;
        }

        // Экранирование HTML для безопасности
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Скрыть ошибку
        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Обработчики событий
        document.addEventListener('DOMContentLoaded', function() {
            // Текстовый поиск по кнопке
            textSearchBtn.addEventListener('click', function() {
                const query = textSearchInput.value.trim();
                if (query) {
                    performTextSearch(query);
                }
            });

            // Текстовый поиск по Enter
            textSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = textSearchInput.value.trim();
                    if (query) {
                        performTextSearch(query);
                    }
                }
            });

            // Поиск по изображению
            imageSearchBtn.addEventListener('click', function() {
                if (uploadInput.files.length > 0) {
                    performImageSearch(uploadInput.files[0]);
                } else {
                    showError('Please select an image first');
                }
            });

            // Debounce для текстового поиска (опционально)
            let searchTimeout;
            textSearchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = textSearchInput.value.trim();

                if (query.length > 2) { // Поиск после 3 символов
                    searchTimeout = setTimeout(() => {
                        performTextSearch(query);
                    }, 500);
                }
            });
        });

        function openModal(productId, name, image, mainCategory, subCategory, discountPrice, actualPrice) {
            currentProductId = productId;

            document.getElementById('modalProductName').textContent = name;
            document.getElementById('modalImage').src = image;
            document.getElementById('modalMainCategory').textContent = mainCategory;
            document.getElementById('modalSubCategory').textContent = subCategory;
            document.getElementById('modalDiscountPrice').textContent = discountPrice;
            document.getElementById('modalActualPrice').textContent = actualPrice;

            document.getElementById('modalMainCategory').style.display = mainCategory ? 'inline-block' : 'none';
            document.getElementById('modalSubCategory').style.display = subCategory ? 'inline-block' : 'none';

            document.getElementById('productModal').style.display = 'block';
            trackView(productId);
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            currentProductId = null;
        }
    </script>
</body>
</html>